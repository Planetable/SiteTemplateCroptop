{% extends 'base.html' %}
{% block head %}
{% include 'modules/post_seo.html' %}
<script>
  const noScrollEffectEdgeDistance = 80;
  const toggleNavVisibilityScrollThreshold = 50;
  let lastScrollTop = 0;

  document.addEventListener('DOMContentLoaded', () => {
    if (!window.PLANET.visitedFromPlanetClient) {
      if(document.getElementById('audio-container')){
        document.querySelector('.audio-container').style.display = 'block';
      }
      if(document.getElementById('footer')){
        document.querySelector('#footer').style.display = 'block';
      }
    } else {
      const topDom = document.getElementById('top-dom');
      topDom.style.display = "none"
      const bodyResetButton = document.getElementById('body-reset-button');
      bodyResetButton.style.display = "none";
    }
  });
</script>
{% include 'modules/deps.html' %}
{% include 'modules/ethers.html' %}
{% include 'modules/utils.html' %}
{% include 'modules/tx.html' %}
{% include 'modules/croptop_publisher.html' %}
{% include 'modules/croptop_deployer.html' %}
{% include 'modules/operator_store.html' %}
{% include 'modules/planet_seo.html' %}
{% endblock %}
{% block main %}
<div id="top-dom">
  {% include 'modules/header.html' %}
</div>
<div id="body-dom" >
  <div class="body-content centered-content">
    <div id="body-reset-button" class="mobile-padding exit-button">[<span class="exit-button-text">all posts &gt;</span>]</div>
    {% include 'modules/post.html' %}
  </div>
</div>
<div id="fork-modal" class="modal negative-space">
  <div class="modal-content body-content centered-content negative-space">
    <div class="exit-button negative-space">[<span class="exit-button-text negative-space">close</span>]</div>
    {% include 'modules/fork.html' %}
  </div>
</div>
<script>
  // Get the fork modal set up.
  const decorateForkModal = () => {
    // Get references to elements that need decorating.
    const forkModal = document.getElementById("fork-modal");
    const topDom = document.getElementById('top-dom');

    // Adjust the size.
    requestAnimationFrame(() => {
      const topDomHeight = topDom.offsetHeight;
      const borderHeight = parseInt(topDom.style.borderBottomWidth, 10);
      const paddingTop = topDomHeight + borderHeight;
      forkModal.style.paddingTop = paddingTop + 'px';
      forkModal.style.height = `calc(100vh - (${paddingTop + 'px'}))`;
    });

    // Make sure the modal is closeable when clicking on empty space.
    let activeElementOnClose;
    forkModal.addEventListener("mousedown", () => {
      activeElementOnClose = document.activeElement;
    });

    forkModal.addEventListener("click", (e) => {
      // Ignore if the clicked view shouldn't close the modal.
      if (!e.target.classList.contains("negative-space")) return;

      // Ignore if the clicked view comes while an input, select, or textarea field is selected.
      if (activeElementOnClose.tagName === "INPUT" || activeElementOnClose.tagName === "SELECT" || activeElementOnClose.tagName === "TEXTAREA") return;

      // Hide the modal.
      forkModal.style.display = "none";
    });

    decorateNewJbForm();
    decoratePermissionForm();
    decorateAllowanceForm();
  }

  const load = async () => {
    startLoadingAnimation('post-form-loading-animation');

    await loadSettings();

    const topDom = document.getElementById('top-dom');
    topDom.style.borderBottomWidth = "1px";

    const imageName = {{ article.hasVideo }} ? '_videoThumbnail.png' : {{ article.hasAudio }} ? '_audioThumbnail.png' : {{ article.attachments.count }} && {{ article.attachments }}.at(0);
    const imageSrc = imageName && './' + imageName;
    const videoSrc = {{ article.hasVideo }} ? './' + '{{ article.videoFilename }}' : null;
    const audioSrc = {{ article.hasAudio }} ? './' + '{{ article.audioFilename }}' : null;
    const name = `{{ article.title }}`;
    const postId = `{{ article.id }}`;
    const created = Math.floor({{ article.created.timeIntervalSince1970 }} * 1000);
    const link = `{{ article.externalLink }}`;
    const content = `{{ content_html }}`;
    const coverAutogenerated = imageName == "_cover.png";

    await decoratePostPage(name, formatDate(new Date(created)), link, content, imageSrc, videoSrc, audioSrc, await encodeIPFSUriFrom('{{ assets_prefix }}', postId), coverAutogenerated);

    stopLoadingAnimation('post-form-loading-animation');
  }

  const toggleNavVisibility = () => {
    const topDom = document.getElementById('top-dom');
    const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const maxScrollTop = document.documentElement.scrollHeight - document.documentElement.clientHeight;

    if (currentScrollTop <= 0) showNav();
    else {
      if (Math.abs(currentScrollTop - lastScrollTop) < toggleNavVisibilityScrollThreshold) return;
      if (lastScrollTop > noScrollEffectEdgeDistance && maxScrollTop - lastScrollTop > noScrollEffectEdgeDistance) {
        if (currentScrollTop > lastScrollTop) hideNav();
        else showNav();
      }
    }
    lastScrollTop = currentScrollTop;
  }

  const setupResetButton = () => {
    const resetButton = document.getElementById('body-reset-button');
    resetButton.addEventListener('click', () => {
      window.location.href = '../';
    });
  }

  const setupPostMode = () => {
    postModeButton.addEventListener('click', async () => {
      window.location.href = '../';
    });
  }

  load();
  setupForking();
  setupResetButton();
  setupPostMode();

  let isUserScroll = false;
  window.addEventListener('load', function() {
    window.requestAnimationFrame(() => {
      window.addEventListener('scroll', function() {
        if (isUserScroll) toggleNavVisibility();
      });
      window.requestAnimationFrame(() => {
        isUserScroll = true;
      });
    });
  });
</script>
{% endblock %}
