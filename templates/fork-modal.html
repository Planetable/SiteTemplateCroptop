<div id="fork-modal" class="modal negative-space">
    <div class="modal-content body-content centered-content content-top-offset negative-space">
      <div class="exit-button mobile-padding negative-space"><span class="exit-button-text negative-space">×</span></div>
      <div id="fork-header" class="body-header mobile-padding negative-space">
        <div class="fork-title">Monetize your media with your own Croptop site</div>
          Set yourself up with a site like the one you're currently on and learn how to start curating posts at <a href="https://croptop.eth.sucks" target="_blank">https://croptop.eth.sucks</a>.
        <div class="fork-info">
          Then, let people buy your posts by making an onchain collection below.
        </div>
        <div class="fork-info">
          Croptop websites connect to blockchains for easy sales while giving creators pro tools to manage their money with their community. Your collection's info can be viewed by anyone, and its onchain money rules can only be adjusted by the admin of the collection. 
        </div>
        <div class="fork-info">
          When deploying, make sure the current website you're on is https://croptop.eth.sucks, or another croptop website you trust.
        </div>
      </div>
      <div id="fork-form" class="form mobile-padding negative-space">
        <div class="form-body">
          <div class="form-section">
            <details>
              <summary class="form-toggle form-main-toggle">Create a collection</summary>
              <div class="form-section">
                <div class="form-section-description">Name and ticker are permanent.</div> 
                <div class="form-item">
  
                  <div class="form-label">Collection name</div>
                  <div class="form-value">
                    <input type="text" placeholder="Your collection name" id="fork-form-new-jb-collection-name-input">
                  </div>
                </div>
                <div class="form-item">
                  <div class="form-label">Collection Ticker</div>
                  <div class="form-value">
                    <input type="text" placeholder="POSTS" id="fork-form-new-jb-collection-symbol-input">
                  </div>
                </div>
              </div>
              <div class="form-section">
                <div class="form-section-description">The admin you set can distribute revenues and change the collection's money rules at any time.</div>
                <div class="form-item form-item-large">
                  <div class="form-label">Admin 
                    <button id="fork-form-new-jb-load-address-button" class="form-load-address-button"><span class="form-load-address-button-text">connect wallet</span></button>
                  </div>
                  <div class="form-value">
                    <input type="text" placeholder="Defaults to your address" id="fork-form-new-jb-project-owner-input">
                  </div>
                </div>
              </div>
              <div class="form-section">
                <div class="form-section-description">The price and total supply of each post in your collection. Anyone can add any content from anywhere to your collection, so long as they buy the first copy.</div>
                <div class="form-item">
                  <div class="form-label">Price</div>
                  <div class="form-value">
                    <span class="ether form-input-prefix">Ξ</span><input type="number" placeholder="free" value="0.01" id="fork-form-new-jb-minimum-price-input" min="0">
                  </div>
                </div>
                <div class="form-item">
                  <div class="form-label">Total supply</div>
                  <div class="form-value">
                    <input type="number" value="1" id="fork-form-new-jb-minimum-total-supply-input" min="1">
                  </div>
                </div>
              </div>
              <div class="form-section" style="display: none;">
                <div class="form-item form-item-large">
                  <div class="form-label">Addresses allowed to buy (one per line)</div>
                  <div class="form-value">
                    <textarea rows="4" id="fork-form-new-jb-addresses-input" placeholder="leave empty for no restrictions"></textarea>
                  </div>
                </div>
              </div>
              <div class="form-section">
                <details id="fork-form-new-jb-revnet-reveal" style="display: none;">
                  <summary class="form-toggle form-main-toggle">advanced – make it a <a href="https://rev.eth.sucks">revnet</a></summary>
                  <div class="form-section">
                    <div class="form-section-description">You can give buyers access to the collection's revenues alongside the admin, with preference to those who buy sooner and stick around longer.
                    </div>
                    <div class="form-item">
                      <div class="form-label">Share revenue with buyers</div>
                      <div class="form-value">
                        <input type="number" placeholder="0" value="50" id="fork-form-new-jb-revnet-split-input" min="0" max="100"><span class="form-input-suffix">%</span>
                      </div>
                    </div>
                  </div>
                  <div class="form-section">
                    <div class="form-section-description">If you want to encourage earlier participation, add a bonus for those buying sooner rather than later. Everyone who participates within the same bonus window will have the same access to the collection's revenues.
                    </div>
                    <div class="form-item">
                      <div class="form-label">Earlier buyer bonus rate</div>
                      <div class="form-value">
                        <input type="number" placeholder="0" value="1" id="fork-form-new-jb-revnet-price-increase-percent-input" min="0" max="100"><span class="form-input-suffix">%</span>
                      </div>
                    </div>
                    <div class="form-item">
                      <div class="form-value">
                        <span class="form-input-prefix">every</span><input type="number" value="3" id="fork-form-new-jb-revnet-price-increase-frequency-input" min="0.001"><span class="form-input-suffix">days</span>
                      </div>
                    </div>
                  </div>
                  <div class="form-section">
                    <div class="form-section-description">If you want to reward longer term participation from everyone including the admin, add a cash-out tax when accessing the collection's revenues sooner rather than later. The cash out tax is set by a value between 0 and 1, where 0 means no tax and 1 is a aggressive tax that makes it very expensive to access the revenue. The tax is shared between the folks remaining.
  
  0 - none. 0.3 - some. 0.7 - more. 0.9 - lots.  
                    </div>
                    <div class="form-item">
                      <div class="form-label">Cash out tax rate</div>
                      <div class="form-value">
                        <input type="number" placeholder="0" value="0.5" id="fork-form-new-jb-revnet-cash-out-tax-rate-input" min="0" max="0.9">
                      </div>
                    </div>
                  </div>
                  <div class="form-section">
                    <div class="form-section-description">As purchases and contributions are made to the collection, access to revenue is tracked and distributed using a token. If you'd like, you can automint some tokens to the admin for preferencial access to revenue.
                    </div>
                    <div class="form-item">
                      <div class="form-label">The price of a token made on the first day of the stage, per unit of revenue received</div>
                      <div class="form-value">
                        <input type="number" placeholder="1000000" value="1000000" id="fork-form-new-jb-revnet-initial-issuance-input" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="form-section">
                    <div class="form-item">
                      <div class="form-label">Tokens to automint</div>
                      <div class="form-value">
                        <input type="number" placeholder="0" value="0" id="fork-form-new-jb-revnet-automint-input" min="0">
                      </div>
                    </div>
                  </div>
                  <div class="form-section">
                    <div class="form-section-description">Some values you just set can evolve over time in stages. If you'd like to schedule a second stage with a new revenue share percent, buyer bonus rate, automint, or cash out tax, specify the amount of time that these first rules above should last for. 
                    </div>
                    <div class="form-item">
                      <div class="form-label">Duration (days)</div>
                      <div class="form-value">
                        <input type="number" placeholder="forever" id="fork-form-new-jb-revnet-duration-input" min="0">
                      </div>
                    </div>
                  </div>
                  <div id="fork-form-new-jb-revnet-stage-2" class="hidden">
                    <div class="form-section">
                      <div class="form-section-description">Add a second stage.</div>                   
                      <div class="form-item">
                        <div class="form-label">Share revenue with buyers</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="90" id="fork-form-new-jb-revnet-split-input-2" min="0" max="100"><span class="form-input-suffix">%</span>
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Earlier buyer bonus rate</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="1" id="fork-form-new-jb-revnet-price-increase-percent-input-2" min="0" max="100"><span class="form-input-suffix">% every</span>
                        </div>
                      </div>
                      <div class="form-item">
                        <div class="form-value">
                          <input type="number" value="3" id="fork-form-new-jb-revnet-price-increase-frequency-input-2" min="0.001"><span class="form-input-suffix">days</span>
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Cash out tax rate</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="0.5" id="fork-form-new-jb-revnet-cash-out-tax-rate-input-2" min="0" max="1">
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">The price of a token made on the first day of the stage, per unit of revenue received</div>
                        <div class="form-value">
                          <input type="number" placeholder="1000000" value="1000000" id="fork-form-new-jb-revnet-initial-issuance-input-2" min="0">
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Tokens to automint</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="0" id="fork-form-new-jb-revnet-automint-input-2" min="0">
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Duration (days)</div>
                        <div class="form-value">
                          <input type="number" placeholder="forever" id="fork-form-new-jb-revnet-duration-input-2" min="0">
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="fork-form-new-jb-revnet-stage-3" class="hidden">
                    <div class="form-section">
                      <div class="form-section-description">Add a third and final stage.</div>                   
                      <div class="form-item">
                        <div class="form-label">Share revenue with buyers</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="90" id="fork-form-new-jb-revnet-split-input-3" min="0" max="100"><span class="form-input-suffix">%</span>
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Earlier buyer bonus rate</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="1" id="fork-form-new-jb-revnet-price-increase-percent-input-3" min="0" max="100"><span class="form-input-suffix">% every</span>
                        </div>
                      </div>
                      <div class="form-item">
                        <div class="form-value">
                          <input type="number" value="3" id="fork-form-new-jb-revnet-price-increase-frequency-input-3" min="0.001"><span class="form-input-suffix">days</span>
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Cash out tax rate</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="0.5" id="fork-form-new-jb-revnet-cash-out-tax-rate-input-3" min="0" max="1">
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">The price of a token made on the first day of the stage, per unit of revenue received</div>
                        <div class="form-value">
                          <input type="number" placeholder="1000000" value="1000000" id="fork-form-new-jb-revnet-initial-issuance-input-3" min="0">
                        </div>
                      </div>
                    </div>
                    <div class="form-section">
                      <div class="form-item">
                        <div class="form-label">Tokens to automint</div>
                        <div class="form-value">
                          <input type="number" placeholder="0" value="0" id="fork-form-new-jb-revnet-automint-input-3" min="0">
                        </div>
                      </div>
                    </div>
                  </div>
                </details>
              </div>
              <div id="fork-form-new-jb-chain" class="form-section">
                <div class="form-section-description">On which chains do you want to deploy your collection? You'll be prompted for a signatute for each chain selected.</div>
                <div class="form-item">
                  <div class="form-value form-select-value">
                    <select id="fork-form-new-jb-state-chain-env" name="chain-env">
                      <option value="production">Production</option>
                      <option value="testnet">Testnet</option>
                    </select>
                  </div>
                  <div class="form-value form-chain-checkbox-value">
                    <div id="fork-form-new-jb-chain-production-options" class="form-chain-options">
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-ethereum-mainnet" name="chain" value="ethereum mainnet">
                        <label for="fork-form-new-jb-ethereum-mainnet">Ethereum Mainnet</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-optimism-mainnet" name="chain" value="optimism mainnet">
                        <label for="fork-form-new-jb-optimism-mainnet">Optimism Mainnet</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-arbitrum-mainnet" name="chain" value="arbitrum mainnet">
                        <label for="fork-form-new-jb-arbitrum-mainnet">Arbitrum Mainnet</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-base-mainnet" name="chain" value="base mainnet">
                        <label for="fork-form-new-jb-base-mainnet">Base Mainnet</label>
                      </div>
                    </div>
                    <div id="fork-form-new-jb-chain-testnet-options" class="form-chain-options" style="display: none;">
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-ethereum-sepolia" name="chain" value="ethereum sepolia">
                        <label for="fork-form-new-jb-ethereum-sepolia">Ethereum Sepolia</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-optimism-sepolia" name="chain" value="optimism sepolia">
                        <label for="fork-form-new-jb-optimism-sepolia">Optimism Sepolia</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-arbitrum-sepolia" name="chain" value="arbitrum sepolia">
                        <label for="fork-form-new-jb-arbitrum-sepolia">Arbitrum Sepolia</label>
                      </div>
                      <div class="form-checkbox-option">
                        <input type="checkbox" id="fork-form-new-jb-base-sepolia" name="chain" value="base sepolia">
                        <label for="fork-form-new-jb-base-sepolia">Base Sepolia</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>           
              <div id="fork-form-new-jb-error-message" class="form-error-message mobile-padding"></div>
              <button id="fork-form-new-jb-submit-button" class="form-button"><span id="fork-form-new-jb-submit-button-text" class="form-button-text">deploy collection</span><span id="fork-form-new-jb-button-loading-animation" class="loading-animation button-loading-animation"></span></button> 
              <div id="fork-form-new-jb-success-message" class="form-success-message mobile-padding"></div>
              <div id="fork-form-new-jb-relayr-quote-section" style="display: none;" class="mt-4">
                <div id="fork-form-new-jb-relayr-quote-details" class="mb-4 p-4 bg-gray-100 rounded"></div>
                <div id="fork-form-new-jb-relayr-payment-options" class="flex flex-col gap-4">
                  <!-- Payment options will be dynamically inserted here -->
                </div>
                <div id="fork-form-new-jb-relayr-deploy-status" style="margin-top: 24px; display: none;"></div>
              </div>
              <div id="fork-form-new-jb-relayr-controls"></div>
            </details>
            <details>
              <summary class="form-toggle form-main-toggle">Extras (wip)</summary>
              <details>
                <summary class="form-toggle form-main-toggle">Let Croptop post to your existing collection</summary>
                <div class="form-section">
                  <div class="form-section-description">Give the Croptop contract permission to sell into your existing collection.</div>
                </div>
                <div id="fork-form-permission-error-message" class="form-error-message mobile-padding"></div>
                <button id="fork-form-permission-submit-button" class="form-button"><span id="fork-form-permission-submit-button-text" class="form-button-text">give permission</span><span id="fork-form-permission-button-loading-animation" class="loading-animation button-loading-animation"></span></button> 
              </details>
              <details>
                <summary class="form-toggle form-main-toggle">Set how Croptop posts to your existing collection</summary>
                <div class="form-section">
                  <div class="form-section-description">Add new restrictions that buyers must meet when adding to your existing collection.</div>
                  <div class="form-item">
                    <div class="form-label">Collection Address</div>
                    <div class="form-value">
                      <input type="string" placeholder="0x..." id="fork-form-allowance-collection-address-input">
                    </div>
                  </div>
                </div>
                <div class="form-section">
                  <div class="form-section-description">The price and total supply of each item in your collection. Anyone can add any content from anywhere to your collection, so long as they buy the first copy.</div>
                  <div class="form-item">
                    <div class="form-label">Price</div>
                    <div class="form-value">
                      <span class="ether form-input-prefix">Ξ</span><input type="number" placeholder="free" value="0.01" id="fork-form-allowance-minimum-price-input" min="0">
                    </div>
                  </div>
                  <div class="form-item">
                    <div class="form-label">Supply</div>
                    <div class="form-value">
                      <input type="number" value="1" id="fork-form-allowance-minimum-total-supply-input" min="1">
                    </div>
                  </div>
                </div>
                <div class="form-section">
                  <div class="form-item form-item-large">
                    <div class="form-label">Addresses allowed to mint (one per line)</div>
                    <div class="form-value">
                      <textarea rows="4" id="fork-form-allowance-addresses-input" placeholder="leave empty for no restrictions"></textarea>
                    </div>
                  </div>
                </div>
                <div class="form-section">
                  <div class="form-item">
                    <div class="form-label">Category on your collection for which the above restrictions apply</div>
                    <div class="form-value">
                      <input type="number" value="0" id="fork-form-allowance-nft-category-input" min="0">
                    </div>
                  </div>
                </div>
                <div id="fork-form-allowance-error-message" class="form-error-message mobile-padding"></div>
                <button id="fork-form-allowance-submit-button" class="form-button"><span id="fork-form-allowance-submit-button-text" class="form-button-text">save restrictions</span><span id="fork-form-allowance-button-loading-animation" class="loading-animation button-loading-animation"></span></button> 
              </details>
            </details>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
  
    let relayrQuote = null;
    let selectedPaymentChainId = null;
    let relayrPolling = false;
    let relayrTxHashes = {};

    const decorateNewJbForm = () => {
      const forkFormChainInput = document.getElementById("fork-form-state-chain-input");
      const forkFormNewJbCollectionNameInput = document.getElementById("fork-form-new-jb-collection-name-input");
      const forkFormNewJbCollectionTickerInput = document.getElementById("fork-form-new-jb-collection-symbol-input");
      const forkFormNewJbProjectOwnerInput = document.getElementById("fork-form-new-jb-project-owner-input");
      const forkFormNewJbMinimumPriceInput = document.getElementById("fork-form-new-jb-minimum-price-input");
      const forkFormNewJbMinimumTotalSupplyInput = document.getElementById("fork-form-new-jb-minimum-total-supply-input");
      const forkFormNewJbAddressesInput = document.getElementById("fork-form-new-jb-addresses-input");
      const forkFormNewJbErrorMessage = document.getElementById("fork-form-new-jb-error-message");
      const forkFormNewJbSuccessMessage = document.getElementById("fork-form-new-jb-success-message");
      const forkFormNewJbSubmitButton = document.getElementById("fork-form-new-jb-submit-button");
      const forkFormNewJbRevnetReveal = document.getElementById("fork-form-new-jb-revnet-reveal");
      const forkFormNewJbRevnetSplitInput = document.getElementById("fork-form-new-jb-revnet-split-input");
      const forkFormNewJbRevnetPriceIncreasePercentInput = document.getElementById("fork-form-new-jb-revnet-price-increase-percent-input");
      const forkFormNewJbRevnetPriceIncreaseFrequencyInput = document.getElementById("fork-form-new-jb-revnet-price-increase-frequency-input");
      const forkFormNewJbRevnetCashOutTaxRateInput = document.getElementById("fork-form-new-jb-revnet-cash-out-tax-rate-input");
      const forkFormNewJbRevnetIssuanceInput = document.getElementById("fork-form-new-jb-revnet-initial-issuance-input");
      const forkFormNewJbRevnetAutomintInput = document.getElementById("fork-form-new-jb-revnet-automint-input");
      const forkFormNewJbRevnetDurationInput = document.getElementById("fork-form-new-jb-revnet-duration-input");
      const forkFormNewJbRevnetSplitInput2 = document.getElementById("fork-form-new-jb-revnet-split-input-2");
      const forkFormNewJbRevnetPriceIncreasePercentInput2 = document.getElementById("fork-form-new-jb-revnet-price-increase-percent-input-2");
      const forkFormNewJbRevnetPriceIncreaseFrequencyInput2 = document.getElementById("fork-form-new-jb-revnet-price-increase-frequency-input-2");
      const forkFormNewJbRevnetCashOutTaxRateInput2 = document.getElementById("fork-form-new-jb-revnet-cash-out-tax-rate-input-2");
      const forkFormNewJbRevnetIssuanceInput2 = document.getElementById("fork-form-new-jb-revnet-initial-issuance-input-2");
      const forkFormNewJbRevnetAutomintInput2 = document.getElementById("fork-form-new-jb-revnet-automint-input-2");
      const forkFormNewJbRevnetDurationInput2 = document.getElementById("fork-form-new-jb-revnet-duration-input-2");
      const forkFormNewJbRevnetSplitInput3 = document.getElementById("fork-form-new-jb-revnet-split-input-3");
      const forkFormNewJbRevnetPriceIncreasePercentInput3 = document.getElementById("fork-form-new-jb-revnet-price-increase-percent-input-3");
      const forkFormNewJbRevnetPriceIncreaseFrequencyInput3 = document.getElementById("fork-form-new-jb-revnet-price-increase-frequency-input-3");
      const forkFormNewJbRevnetCashOutTaxRateInput3 = document.getElementById("fork-form-new-jb-revnet-cash-out-tax-rate-input-3");
      const forkFormNewJbRevnetIssuanceInput3 = document.getElementById("fork-form-new-jb-revnet-initial-issuance-input-3");
      const forkFormNewJbRevnetAutomintInput3 = document.getElementById("fork-form-new-jb-revnet-automint-input-3");
      const forkFormNewJbRevnetDurationInput3 = document.getElementById("fork-form-new-jb-revnet-duration-input-3");
      const forkFormNewJbRevnetStage2 = document.getElementById("fork-form-new-jb-revnet-stage-2");
      const forkFormNewJbRevnetStage3 = document.getElementById("fork-form-new-jb-revnet-stage-3");
      const forkFormNewJbChainEnvSelect = document.getElementById('fork-form-new-jb-state-chain-env');
      const forkFormNewJbChainProductionOptions = document.getElementById('fork-form-new-jb-chain-production-options');
      const forkFormNewJbChainTestnetOptions = document.getElementById('fork-form-new-jb-chain-testnet-options');
  
      // Disable the button.
      forkFormNewJbSubmitButton.disabled = true;
  
      // Set values in the form if the fields are not yet set.
      if (!forkFormNewJbProjectOwnerInput.value && signer) forkFormNewJbProjectOwnerInput.value = signer;
  
      // Allow connecting wallet to prefill beneficiary input field.
      const loadAddressButton = document.getElementById("fork-form-new-jb-load-address-button");
      loadAddressButton.onclick = async () => {
        signer = (await getSigner()).address;
        forkFormNewJbProjectOwnerInput.value = signer;
      };
  
      forkFormNewJbChainEnvSelect.addEventListener('change', function() {
        if (this.value === 'production') {
          forkFormNewJbChainProductionOptions.style.display = 'block';
          forkFormNewJbChainTestnetOptions.style.display = 'none';
        } else {
          forkFormNewJbChainProductionOptions.style.display = 'none';
          forkFormNewJbChainTestnetOptions.style.display = 'block';
        }
      });
  
      // Get Duration input 1, onchange either show or hide section 2 and 3.
      forkFormNewJbRevnetDurationInput.addEventListener("input", () => {
        if (forkFormNewJbRevnetDurationInput.value == "" || forkFormNewJbRevnetDurationInput.value == "0") {
           forkFormNewJbRevnetStage2.classList.add("hidden");
           forkFormNewJbRevnetStage3.classList.add("hidden");
        } else if (parseInt(forkFormNewJbRevnetDurationInput.value) % parseInt(forkFormNewJbRevnetPriceIncreaseFrequencyInput.value) == 0) {
          forkFormNewJbRevnetStage2.classList.remove("hidden");
          if (forkFormNewJbRevnetDurationInput2.value == "" || forkFormNewJbRevnetDurationInput2.value == "0") {
            forkFormNewJbRevnetStage3.classList.add("hidden");
          } else if (parseInt(forkFormNewJbRevnetDurationInput2.value) % parseInt(forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value) == 0) {
            forkFormNewJbRevnetStage3.classList.remove("hidden");
          } 
        }
      })
  
      // Get Duration input 2, onchange either show or hide section 3.
      forkFormNewJbRevnetDurationInput2.addEventListener("input", (input) => {
        if (forkFormNewJbRevnetDurationInput2.value == "" || forkFormNewJbRevnetDurationInput2.value == "0") {
           forkFormNewJbRevnetStage3.classList.add("hidden");
        } else if (parseInt(forkFormNewJbRevnetDurationInput2.value) % parseInt(forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value) == 0) {
          forkFormNewJbRevnetStage3.classList.remove("hidden");
        }
      });
  
  
      const checkState = async () => {
        // Set error messages if the currently inputted values are too small.
        if (Number(forkFormNewJbRevnetPriceIncreasePercentInput.value) > 100 || Number(forkFormNewJbRevnetPriceIncreasePercentInput2.value) > 100 || Number(forkFormNewJbRevnetPriceIncreasePercentInput2.value) > 100 || 
  Number(forkFormNewJbRevnetSplitInput.value) > 100 || Number(forkFormNewJbRevnetSplitInput2.value) > 100 || Number(forkFormNewJbRevnetSplitInput2.value) > 100) {
          forkFormNewJbErrorMessage.innerHTML = `Percents must be between 0% and 100%.`;
          forkFormNewJbErrorMessage.classList.add("warn");
          forkFormNewJbErrorMessage.style.display = "block";
          forkFormNewJbSubmitButton.disabled = true;
        } else if (Number(forkFormNewJbRevnetCashOutTaxRateInput.value) > 1 || Number(forkFormNewJbRevnetCashOutTaxRateInput2.value) > 1 || Number(forkFormNewJbRevnetCashOutTaxRateInput3.value) > 1) {
          forkFormNewJbErrorMessage.innerHTML = `Cash out tax rate must be between 0 and 1.`;
          forkFormNewJbErrorMessage.classList.add("warn");
          forkFormNewJbErrorMessage.style.display = "block";
          forkFormNewJbSubmitButton.disabled = true;
        } else if ((forkFormNewJbRevnetPriceIncreasePercentInput.value && !forkFormNewJbRevnetPriceIncreaseFrequencyInput.value) || (forkFormNewJbRevnetDurationInput.value && forkFormNewJbRevnetPriceIncreasePercentInput2.value && !forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value) || (forkFormNewJbRevnetDurationInput2.value && forkFormNewJbRevnetPriceIncreaseFrequencyInput3.value && !forkFormNewJbRevnetPriceIncreaseFrequencyInput3)) { 
          forkFormNewJbErrorMessage.innerHTML = `Add a bonus frequency alongside the bonus percent.`;
          forkFormNewJbErrorMessage.classList.add("warn");
          forkFormNewJbErrorMessage.style.display = "block";
          forkFormNewJbSubmitButton.disabled = true;
        } else if (forkFormNewJbRevnetDurationInput.value != "" && forkFormNewJbRevnetDurationInput.value != "0" && parseInt(forkFormNewJbRevnetDurationInput.value) % parseInt(forkFormNewJbRevnetPriceIncreaseFrequencyInput.value) != 0) { 
          forkFormNewJbErrorMessage.innerHTML = `The stage duration (${forkFormNewJbRevnetDurationInput.value}) must be a multiple of the bonus frequency (${forkFormNewJbRevnetPriceIncreaseFrequencyInput.value}).`;
          forkFormNewJbErrorMessage.classList.add("warn");
          forkFormNewJbErrorMessage.style.display = "block";
          forkFormNewJbSubmitButton.disabled = true;
        } else if (forkFormNewJbRevnetDurationInput2.value != "" && forkFormNewJbRevnetDurationInput2.value != "0" && parseInt(forkFormNewJbRevnetDurationInput2.value) % parseInt(forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value) != 0) { 
          forkFormNewJbErrorMessage.innerHTML = `The second stage duration (${forkFormNewJbRevnetDurationInput2.value}) must be a multiple of the bonus frequency (${forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value}).`;
          forkFormNewJbErrorMessage.classList.add("warn");
          forkFormNewJbErrorMessage.style.display = "block";
          forkFormNewJbSubmitButton.disabled = true;
        } else {
          // Hide the error message.
          forkFormNewJbErrorMessage.style.display = "none";
          forkFormNewJbSubmitButton.disabled = false;
        }
      }
  
      // Prevent excessive calls.
      let checkStateTimer;
      const queueCheckState = async () => {
        clearTimeout(checkStateTimer);
        checkStateTimer = setTimeout(checkState, formInputReactionTimeDelay);
      }
  
      // Update the form's state each time the values change.
      forkFormNewJbCollectionNameInput.addEventListener("input", queueCheckState);
      forkFormNewJbCollectionTickerInput.addEventListener("input", queueCheckState);
      forkFormNewJbMinimumPriceInput.addEventListener("input", queueCheckState);
      forkFormNewJbMinimumTotalSupplyInput.addEventListener("input", queueCheckState);
      forkFormNewJbMaximumTotalSupplyInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetSplitInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetSplitInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetSplitInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetAutomintInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetAutomintInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetAutomintInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetIssuanceInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetIssuanceInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetIssuanceInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreasePercentInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreasePercentInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreasePercentInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreaseFrequencyInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreaseFrequencyInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetPriceIncreaseFrequencyInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetCashOutTaxRateInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetCashOutTaxRateInput2.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetCashOutTaxRateInput3.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetDurationInput.addEventListener("input", queueCheckState);
      forkFormNewJbRevnetDurationInput2.addEventListener("input", queueCheckState);
  
      // Default to max
      // Set values in the form if the fields are not yet set.
      if (!forkFormNewJbMaximumTotalSupplyInput.value) forkFormNewJbMaximumTotalSupplyInput.value = 1000000000;
      // Default to 1
      if (!forkFormNewJbMinimumTotalSupplyInput.value) forkFormNewJbMinimumTotalSupplyInput.value = 1;
      // Default to free
      if (!forkFormNewJbMinimumPriceInput.value) forkFormNewJbMinimumPriceInput.value = 0;
      if (!forkFormNewJbRevnetAutomintInput.value) forkFormNewJbRevnetAutomintInput.value = 0;
      if (!forkFormNewJbRevnetAutomintInput2.value) forkFormNewJbRevnetAutomintInput2.value = 0;
      if (!forkFormNewJbRevnetAutomintInput3.value) forkFormNewJbRevnetAutomintInput3.value = 0;
      if (!forkFormNewJbRevnetIssuanceInput.value) forkFormNewJbRevnetIssuanceInput.value = 0;
      if (!forkFormNewJbRevnetIssuanceInput2.value) forkFormNewJbRevnetIssuanceInput2.value = 0;
      if (!forkFormNewJbRevnetIssuanceInput3.value) forkFormNewJbRevnetIssuanceInput3.value = 0;
      if (!forkFormNewJbRevnetSplitInput.value) forkFormNewJbRevnetSplitInput.value = 0;
      if (!forkFormNewJbRevnetSplitInput2.value) forkFormNewJbRevnetSplitInput2.value = 0;
      if (!forkFormNewJbRevnetSplitInput3.value) forkFormNewJbRevnetSplitInput3.value = 0;
      if (!forkFormNewJbRevnetPriceIncreasePercentInput.value) forkFormNewJbRevnetPriceIncreasePercentInput.value = 0;
      if (!forkFormNewJbRevnetPriceIncreasePercentInput2.value) forkFormNewJbRevnetPriceIncreasePercentInput2.value = 0;
      if (!forkFormNewJbRevnetPriceIncreasePercentInput3.value) forkFormNewJbRevnetPriceIncreasePercentInput3.value = 0;
      if (!forkFormNewJbRevnetPriceIncreaseFrequencyInput.value) forkFormNewJbRevnetPriceIncreaseFrequencyInput.value = 0;
      if (!forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value) forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value = 0;
      if (!forkFormNewJbRevnetPriceIncreaseFrequencyInput3.value) forkFormNewJbRevnetPriceIncreaseFrequencyInput3.value = 0;
      if (!forkFormNewJbRevnetCashOutTaxRateInput.value) forkFormNewJbRevnetCashOutTaxRateInput.value = 0;
      if (!forkFormNewJbRevnetCashOutTaxRateInput2.value) forkFormNewJbRevnetCashOutTaxRateInput2.value = 0;
      if (!forkFormNewJbRevnetCashOutTaxRateInput3.value) forkFormNewJbRevnetCashOutTaxRateInput3.value = 0;
      if (!forkFormNewJbRevnetDurationInput.value) forkFormNewJbRevnetDurationInput.value = 0;
      if (!forkFormNewJbRevnetDurationInput2.value) forkFormNewJbRevnetDurationInput2.value = 0;
  
      // Get selected chain IDs
      const getSelectedChainIds = () => {
        const env = document.getElementById('fork-form-new-jb-state-chain-env').value;
        const optionsId = env === 'production' 
          ? 'fork-form-new-jb-chain-production-options'
          : 'fork-form-new-jb-chain-testnet-options';
        const checkboxes = document.querySelectorAll(`#${optionsId} input[type="checkbox"]:checked`);
        return Array.from(checkboxes).map(cb => resolveChainId(cb.value));
      };

      // Update button text based on selected chains
      const updateDeployButtonText = () => {
        const selectedChains = getSelectedChainIds();
        const buttonText = selectedChains.length > 1 ? "get deploy quote" : "deploy collection";
        document.getElementById('fork-form-new-jb-submit-button-text').textContent = buttonText;
      };

      // Add chain selection change listeners
      const chainCheckboxes = document.querySelectorAll('input[name="chain"]');
      chainCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeployButtonText);
      });

      // Set loading state
      const setLoadingState = (state) => {
        const submitButton = document.getElementById('fork-form-new-jb-submit-button');
        const loadingAnimation = document.getElementById('fork-form-new-jb-button-loading-animation');
        if (state) {
          submitButton.disabled = true;
          loadingAnimation.style.display = 'inline-block';
          // Show extra text only for get deploy quote
          const btnText = document.getElementById('fork-form-new-jb-submit-button-text').textContent;
        } else {
          submitButton.disabled = false;
          loadingAnimation.style.display = 'none';
        }
      };

      // Show error
      const showError = (message) => {
        const errorMessage = document.getElementById('fork-form-new-jb-error-message');
        errorMessage.innerHTML = message;
        errorMessage.style.display = "block";
      };

      // Show success
      const showSuccess = (message) => {
        const successMessage = document.getElementById('fork-form-new-jb-success-message');
        successMessage.innerHTML = message;
        successMessage.style.display = "block";
      };

      // Reset form and UI
      const resetFormAndUI = () => {
        const successMessage = document.getElementById('fork-form-new-jb-success-message');
        const errorMessage = document.getElementById('fork-form-new-jb-error-message');
        const relayrSection = document.getElementById('fork-form-new-jb-relayr-quote-section');
        
        successMessage.style.display = "none";
        errorMessage.style.display = "none";
        relayrSection.style.display = 'none';
        
        selectedPaymentChainId = null;
        relayrQuote = null;
        relayrPolling = false;
      };

      const showRelayrQuoteUI = (quote) => {
        const relayrSection = document.getElementById('fork-form-new-jb-relayr-quote-section');
        const paymentOptionsDiv = document.getElementById('fork-form-new-jb-relayr-payment-options');
        relayrSection.style.display = 'block';
        paymentOptionsDiv.innerHTML = '';

        // Quote status
        const statusBox = document.createElement('div');
        statusBox.className = 'form-quote-status-box';
        statusBox.innerHTML = `Quote complete <span style="color: #3bb273; font-size: 1.3em; margin-left: 8px;">&#10003;</span>`;
        paymentOptionsDiv.appendChild(statusBox);

        // Expiry (5 min default)
        const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // or use quote.expiry if available
        const expiresText = document.createElement('div');
        expiresText.style.marginBottom = '16px';
        expiresText.style.fontSize = '0.98em';
        expiresText.style.color = '#444';
        expiresText.innerHTML = `Quote valid until <b>${expiresAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</b>. <a href="#" id="clear-quote-link" style="color:#888;text-decoration:underline;">clear quote</a>`;
        paymentOptionsDiv.appendChild(expiresText);

        // Payment dropdown label
        const label = document.createElement('div');
        label.innerText = 'How would you like to pay?';
        label.className = 'form-label'
         ;
        paymentOptionsDiv.appendChild(label);

        // Payment dropdown (styled like the rest of the site)
        const formItem = document.createElement('div');
        formItem.className = 'form-item';

        const selectWrapper = document.createElement('div');
        selectWrapper.className = 'form-value form-select-value';

        const select = document.createElement('select');
        select.id = 'relayr-payment-chain-dropdown';

        quote.payment_info.forEach((info, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          const eth = formatEth(info.amount);
          const chain = resolveChainLabel(info.chain) || info.chain;
          opt.innerText = `${eth} ETH on ${chain}`;
          select.appendChild(opt);
        });
        selectWrapper.appendChild(select);
        formItem.appendChild(selectWrapper);
        paymentOptionsDiv.appendChild(formItem);

        // Pay button (left aligned, not full width)
        const payBtn = document.createElement('button');
        payBtn.className = 'form-button';
        payBtn.innerText = 'deploy collection';
        payBtn.disabled = false;
        // Add a unique spinner span for this button
        const spinnerId = 'relayr-pay-btn-spinner';
        const spinner = document.createElement('span');
        spinner.id = spinnerId;
        spinner.className = 'loading-animation button-loading-animation';
        spinner.style.display = 'none';
        payBtn.appendChild(spinner);
        payBtn.onclick = async () => {
          const idx = select.value;
          const paymentInfo = quote.payment_info[idx];
          payBtn.disabled = true;
          startLoadingAnimation(spinnerId);
          try {
            const sendTx = sendRelayrTx(paymentInfo);
            // Robust logging and error handling for status table
            try {
              const statusDiv = document.getElementById('fork-form-new-jb-relayr-deploy-status');
              statusDiv.style.display = 'block';
              renderRelayrStatusTable({transactions: quote.payment_info.map((info) => ({
                request: {chain: info.chain},
                status: {state: 'Pending'}
              }))});
              pollRelayrBundleStatus(quote.bundle_uuid, renderRelayrStatusTable);
              await sendTx;
            } catch (tableErr) {
              showError('Error showing deployment status. Please try again or contact support.');
            }
          } catch (e) {
            let msg = e && e.message ? e.message : String(e);
            if (msg.includes('insufficient funds')) {
              msg = 'Insufficient funds for gas and payment.';
            }
            showError(msg);
          } finally {
            payBtn.disabled = false;
            stopLoadingAnimation(spinnerId);
          }
        };
        paymentOptionsDiv.appendChild(payBtn);

        // Clear quote handler
        setTimeout(() => {
          const clearLink = document.getElementById('clear-quote-link');
          if (clearLink) {
            clearLink.onclick = (e) => {
              e.preventDefault();
              relayrSection.style.display = 'none';
              // Optionally reset state/quote here
            };
          }
        }, 0);
      };

      // Submit the form.
      forkFormNewJbSubmitButton.onclick = async () => {
        // Check for empty values.
        if (!forkFormNewJbCollectionNameInput.value || !forkFormNewJbCollectionTickerInput.value || forkFormNewJbMinimumPriceInput.value == "" || !forkFormNewJbMaximumTotalSupplyInput.value || !forkFormNewJbMinimumTotalSupplyInput.value || forkFormNewJbRevnetAutomintInput.value == "" || forkFormNewJbRevnetAutomintInput2.value == "" || forkFormNewJbRevnetAutomintInput3.value == "" || forkFormNewJbRevnetIssuanceInput.value == "" || forkFormNewJbRevnetSplitInput.value == "" || forkFormNewJbRevnetPriceIncreasePercentInput.value == "" || !forkFormNewJbRevnetPriceIncreaseFrequencyInput.value || forkFormNewJbRevnetCashOutTaxRateInput.value == "" || (Number(forkFormNewJbRevnetDurationInput.value) && (forkFormNewJbRevnetIssuanceInput2.value == "" || forkFormNewJbRevnetSplitInput2.value == "" || forkFormNewJbRevnetPriceIncreasePercentInput2.value == "" || !forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value || forkFormNewJbRevnetCashOutTaxRateInput2.value == "")) || (Number(forkFormNewJbRevnetDurationInput2.value) && (forkFormNewJbRevnetIssuanceInput3.value == "" || forkFormNewJbRevnetSplitInput3.value == "" || forkFormNewJbRevnetPriceIncreasePercentInput3.value == "" || !forkFormNewJbRevnetPriceIncreaseFrequencyInput3.value || forkFormNewJbRevnetCashOutTaxRateInput3.value == "" ))) {
          forkFormNewJbErrorMessage.innerHTML = "Fill out the form.";
          forkFormNewJbErrorMessage.style.display = "block";
          return;
        } 
  
        // Default to the signer.
        signer = (await getSigner()).address;
        if (!forkFormNewJbProjectOwnerInput.value) forkFormNewJbProjectOwnerInput.value = signer;
  
        // Show the loading animation.
        startLoadingAnimation('fork-form-new-jb-button-loading-animation');
  
        // Get selected chain IDs
        const selectedChainIds = getSelectedChainIds();
        if (selectedChainIds.length === 0) {
          showError("Please select at least one chain");
          return;
        }
  
        // Normalize values from the form.
        const name = forkFormNewJbCollectionNameInput.value;
        const symbol = forkFormNewJbCollectionTickerInput.value;
        const owner = forkFormNewJbProjectOwnerInput.value;
        const minimumPrice = fixedPointNumber(forkFormNewJbMinimumPriceInput.value, 18);
        const supply = forkFormNewJbMinimumTotalSupplyInput.value;
        const minimumTotalSupply = supply;
        const maximumTotalSupply = supply;
        const allowedAddresses = !forkFormNewJbAddressesInput.value ? [] : forkFormNewJbAddressesInput.value.split('\n');
        const stage1AutomintTokenAmount = fixedPointNumber(forkFormNewJbRevnetAutomintInput.value, 18); 
        const stage2AutomintTokenAmount = fixedPointNumber(forkFormNewJbRevnetAutomintInput2.value, 18); 
        const stage3AutomintTokenAmount = fixedPointNumber(forkFormNewJbRevnetAutomintInput3.value, 18); 
        const stage1InitialIssuanceAmount = fixedPointNumber(forkFormNewJbRevnetIssuanceInput.value, 18);
        const stage2InitialIssuanceAmount = fixedPointNumber(forkFormNewJbRevnetIssuanceInput2.value, 18);
        const stage3InitialIssuanceAmount = fixedPointNumber(forkFormNewJbRevnetIssuanceInput3.value, 18); 
        const stage1SplitPercent = 10000 - Math.round(forkFormNewJbRevnetSplitInput.value * 100);
        const stage2SplitPercent = 10000 - Math.round(forkFormNewJbRevnetSplitInput2.value * 100);
        const stage3SplitPercent = 10000 - Math.round(forkFormNewJbRevnetSplitInput3.value * 100);
        const stage1PriceIncreasePercent = Math.round(forkFormNewJbRevnetPriceIncreasePercentInput.value * 100);
        const stage2PriceIncreasePercent = Math.round(forkFormNewJbRevnetPriceIncreasePercentInput2.value * 100);
        const stage3PriceIncreasePercent = Math.round(forkFormNewJbRevnetPriceIncreasePercentInput3.value * 100);
        const stage1PriceIncreaseFrequency = forkFormNewJbRevnetPriceIncreaseFrequencyInput.value * 86400;
        const stage2PriceIncreaseFrequency = forkFormNewJbRevnetPriceIncreaseFrequencyInput2.value * 86400;
        const stage3PriceIncreaseFrequency = forkFormNewJbRevnetPriceIncreaseFrequencyInput3.value * 86400;
        const stage1CashOutTaxRate = Math.round(forkFormNewJbRevnetCashOutTaxRateInput.value * 10000);
        const stage2CashOutTaxRate = Math.round(forkFormNewJbRevnetCashOutTaxRateInput2.value * 10000);
        const stage3CashOutTaxRate = Math.round(forkFormNewJbRevnetCashOutTaxRateInput3.value * 10000);
        const stage2StartsAtOrAfter = forkFormNewJbRevnetDurationInput.value == "0" ? 0 : Math.floor(Date.now() / 1000) + forkFormNewJbRevnetDurationInput.value * 86400;
        const stage3StartsAtOrAfter = forkFormNewJbRevnetDurationInput2.value == "0" ? 0 : stage2StartsAtOrAfter + forkFormNewJbRevnetDurationInput2.value * 86400;
        
        try {
          // Generate a salt for this deploy
          const salt = generateSalt();

          // If multiple chains are selected, use Relayr
          if (selectedChainIds.length > 1) {
            const quote = await tx_deploy_project(
              name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply, 
              allowedAddresses, selectedChainIds, salt
            );
            
            if (!quote || !quote.payment_info) {
              throw new Error('Failed to get valid Relayr quote');
            }

            relayrQuote = quote;
            showRelayrQuoteUI(quote);
            return;
          }

          // Single chain deployment
          const collectionAddress = await tx_deploy_project(
            name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply,
            allowedAddresses, selectedChainIds, salt
          );

          if (!collectionAddress) {
            showError("The connected network isn't supported.");
          } else {
            showSuccess(`Success! ${collectionAddress} is your collection's address on chain ID ${selectedChainIds[0]}.`);
          }

        } catch (e) {
          showError(e.message || e);
        } finally {
          setLoadingState(false);
        }
      };

      // Initial button text update
      updateDeployButtonText();
    }
  
    const decoratePermissionForm = () => {
      const forkFormChainInput = document.getElementById("fork-form-state-chain-input");
      const forkFormPermissionSubmitButton = document.getElementById("fork-form-permission-submit-button");
      const forkFormPermissionErrorMessage = document.getElementById("fork-form-permission-error-message");
  
      // Submit the form.
      forkFormPermissionSubmitButton.onclick = async () => {
  
        // Show the loading animation.
        startLoadingAnimation('fork-form-permission-button-loading-animation');
  
        // Make sure the client is connected to the right network.
        const chainId = await getChainId();
  
        try {
          // Get the signer.
          signer = (await getSigner()).address;
  
          // Try to process the transaction.
          const accepted = await tx_set_permissions(signer, chainId);
  
          // Show incompatible network if needed.
          if (!accepted) { 
            // Show the error message.
            forkFormPermissionErrorMessage.innerHTML = "The connected network isn't supported.";
            forkFormPermissionErrorMessage.style.display = "block";
          }
  
          // Hide the loading animation.
          stopLoadingAnimation('fork-form-permission-button-loading-animation');
        } catch (e) {
          forkFormPermissionErrorMessage.innerHTML = e;
          forkFormPermissionErrorMessage.style.display = "block";
  
          // Hide the loading animation.
          stopLoadingAnimation('fork-form-permission-button-loading-animation');
        }
      }
    }
  
    const decorateAllowanceForm = () => {
      const forkFormChainInput = document.getElementById("fork-form-state-chain-input");
      const forkFormAllowanceSubmitButton = document.getElementById("fork-form-allowance-submit-button");
      const forkFormAllowanceCollectionAddressInput = document.getElementById("fork-form-allowance-collection-address-input");
      const forkFormAllowanceCategoryInput = document.getElementById("fork-form-allowance-nft-category-input");
      const forkFormAllowanceMinimumPriceInput = document.getElementById("fork-form-allowance-minimum-price-input");
      const forkFormAllowanceMinimumTotalSupplyInput = document.getElementById("fork-form-allowance-minimum-total-supply-input");
      const forkFormAllowanceAddressesInput = document.getElementById("fork-form-allowance-addresses-input");
      const forkFormAllowanceErrorMessage = document.getElementById("fork-form-allowance-error-message");
  
      // Submit the form.
      forkFormAllowanceSubmitButton.onclick = async () => {
        // Check for empty values.
        if (!forkFormAllowanceCollectionAddressInput.value || !forkFormAllowanceCategoryInput.value) {
          forkFormAllowanceErrorMessage.innerHTML = "Fill out the form.";
          forkFormAllowanceErrorMessage.style.display = "block";
          return;
        } else {
          // Hide the error message.
          forkFormAllowanceErrorMessage.style.display = "none";
        }
        // Default to 1
        if (!forkFormAllowanceMinimumTotalSupplyInput.value) forkFormAllowanceMinimumTotalSupplyInput.value = 1;
        // Default to free
        if (!forkFormAllowanceMinimumPriceInput.value) forkFormAllowanceMinimumPriceInput.value = 0;
  
        // Show the loading animation.
        startLoadingAnimation('fork-form-allowance-button-loading-animation');
  
        // Get the signer.
        signer = (await getSigner()).address;
  
        // Make sure the client is connected to the right network.
        const chainId = await getChainId();
  
        // Normalize values from the form.
        const collectionAddress = forkFormAllowanceCollectionAddressInput.value;
        const category = forkFormAllowanceCategoryInput.value;
        const minimumPrice = fixedPointNumber(forkFormAllowanceMinimumPriceInput.value, 18); 
        const supply = forkFormAllowanceMinimumTotalSupplyInput.value;
        const minimumTotalSupply = supply;
        const maximumTotalSupply = supply;
        const allowedAddresses = !forkFormAllowanceAddressesInput.value ? [] : forkFormAllowanceAddressesInput.value.split('\n');
  
        try {
          // Try to process the transaction.
          const accepted = await tx_configure(collectionAddress, category, minimumPrice, minimumTotalSupply, maximumTotalSupply, allowedAddresses, chainId);
  
          // Show incompatible network if needed.
          if (!accepted) { 
            // Show the error message.
            forkFormAllowanceErrorMessage.innerHTML = "The connected network isn't supported.";
            forkFormAllowanceErrorMessage.style.display = "block";
          }
  
          // Hide the loading animation.
          stopLoadingAnimation('fork-form-allowance-button-loading-animation');
        } catch (e) {
          forkFormAllowanceErrorMessage.innerHTML = e;
          forkFormAllowanceErrorMessage.style.display = "block";
  
          // Hide the loading animation.
          stopLoadingAnimation('fork-form-allowance-button-loading-animation');
        }
      }  
    }

    function renderRelayrStatusTable(bundleStatus) {
      const statusDiv = document.getElementById('fork-form-new-jb-relayr-deploy-status');
      statusDiv.style.display = 'block';

      if (!bundleStatus || !Array.isArray(bundleStatus.transactions)) {
        statusDiv.innerHTML = '<div class="relayr-status-table-failed">Error: Could not load deployment status. Please try again or contact support.</div>';
        return;
      }

      // Table container styling
      let html = `<div class="relayr-status-table-desc">
        Your project is made up of components deployed on each blockchain where it'll accept funds and issue tokens from. These transactions take 1-2 minutes to settle.
      </div>`;

      html += `<div class="relayr-status-table-container">
        <table class="relayr-status-table">
          <tr>
            <th>Network</th>
            <th>Status</th>
            <th>Tx</th>
          </tr>`;

      let collectionAddress = null;
      for (const tx of bundleStatus.transactions) {
        const chain = resolveChainLabel(tx.request.chain) || tx.request.chain;
        const state = tx.status && tx.status.state;
        let statusIcon = '';
        let statusText = '';
        // Persist and use tx hash
        let txHash = tx.status && (tx.status.tx_hash || (tx.status.data && tx.status.data.transaction && tx.status.data.transaction.hash));
        if (txHash) {
          relayrTxHashes[tx.request.chain] = txHash;
        } else if (relayrTxHashes[tx.request.chain]) {
          txHash = relayrTxHashes[tx.request.chain];
        }
        let txLink = '<span class="relayr-status-table-txlink">generating...</span>';

        if (state === 'Pending' || state === 'Mempool') {
          statusIcon = `<span class="relayr-status-table-pending" style="font-size:1.2em; vertical-align:middle;">&#9711;</span>`;
          statusText = 'Pending';
        } else if (state === 'Success' || state === 'Included') {
          statusIcon = `<span class="relayr-status-table-success" style="font-size:1.2em; vertical-align:middle;">&#10003;</span>`;
          statusText = state;
          if (txHash) {
            const explorer = chainExplorerUrls(tx.request.chain);
            txLink = `<a href="${explorer}${txHash}" target="_blank" class="relayr-status-table-success">View</a>`;
          }

          // Extract collection address from calldata if available
          if (tx.receipt && !collectionAddress) {
            const interface = new ethers.Interface(croptopDeployerContractABI);
            const decodedLog = interface.parseLog(tx.receipt.logs[0]);
            collectionAddress = decodedLog.args[1]; 
          }
        } else if (state === 'Failed') {
          statusIcon = `<span class="relayr-status-table-failed" style="font-size:1.2em; vertical-align:middle;">&#10007;</span>`;
          statusText = 'Failed';
          txLink = '-';
        } else {
          statusIcon = '';
          statusText = 'Unknown';
          txLink = '-';
        }

        html += `<tr>
          <td>${chain}</td>
          <td>${statusIcon} ${statusText}</td>
          <td>${txLink}</td>
        </tr>`;
      }
      html += '</table></div>';

      // Show collection address if available
      if (collectionAddress) {
        html += `<div class="relayr-status-table-address">Collection address: ${collectionAddress}</div>`;
      }

      // Show help message if at least one tx has a View link
      const hasViewLink = bundleStatus.transactions.some(tx => {
        const state = tx.status && tx.status.state;
        return (state === 'Success' || state === 'Included') && (tx.status && (tx.status.tx_hash || (tx.status.data && tx.status.data.transaction && tx.status.data.transaction.hash)));
      });
      if (hasViewLink) {
        html += `<div class="relayr-status-table-help">
          <b>How to find your collection (hook) address:</b><br>
          Click a <span class='relayr-status-table-success'>View</span> button, go to the <b>Logs</b> tab, and read the first event.
        </div>`;
      }

      statusDiv.innerHTML = html;
    }
  </script>
