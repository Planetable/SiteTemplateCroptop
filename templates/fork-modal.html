<div id="fork-modal" class="modal negative-space">
    <div class="modal-content body-content centered-content content-top-offset negative-space">
      <div class="exit-button mobile-padding negative-space"><span class="exit-button-text negative-space">×</span></div>
      <div id="fork-header" class="body-header mobile-padding negative-space">
        <div class="fork-title">Monetize your media with your own Croptop site</div>
          Get your own site like this one and learn how to start posting at <a href="https://croptop.eth.sucks" target="_blank">https://croptop.eth.sucks</a>.
        <div class="fork-info">
          Then, let people buy your posts by making a collection below.
        </div>
        <div class="fork-info">
          Croptop websites connect to blockchains for easy sales while giving creators pro tools to grow their money with their community. Your collection's info can be viewed by anyone, and its onchain money rules are supercharged by giving collectors rewards that incentivize buying sooner and sharing your site with others. 
        </div>
        <div class="fork-info">
          When deploying, make sure the current website you're on is https://croptop.eth.sucks, or another croptop website you trust.
        </div>
      </div>
      <div id="fork-form" class="form mobile-padding negative-space">
        <div class="form-body">
          <div class="form-section">
            <div class="form-section-description">Name and ticker are permanent.</div> 
            <div class="form-item">

              <div class="form-label">Collection name</div>
              <div class="form-value">
                <input type="text" placeholder="Your collection name" id="fork-form-new-jb-collection-name-input">
              </div>
            </div>
            <div class="form-item">
              <div class="form-label">Ticker</div>
              <div class="form-value">
                <input type="text" placeholder="POSTS" id="fork-form-new-jb-collection-symbol-input">
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-description">Set the address that manages your collection's revenues.</div>
            <div class="form-item form-item-large">
              <div class="form-label">Revenue manager
                <button id="fork-form-new-jb-load-address-button" class="form-load-address-button"><span class="form-load-address-button-text">connect wallet</span></button>
              </div>
              <div class="form-value">
                <input type="text" placeholder="Defaults to your address" id="fork-form-new-jb-project-owner-input">
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="form-section-description">Set a price and number of copies for each post in your collection.</div>
            <div class="form-item">
              <div class="form-label">Price</div>
              <div class="form-value">
                <span class="ether form-input-prefix">Ξ</span><input type="number" placeholder="free" value="0.001" id="fork-form-new-jb-minimum-price-input" min="0">
              </div>
            </div>
            <div class="form-item">
              <div class="form-label">Copies</div>
              <div class="form-value">
                <input type="number" value="100" id="fork-form-new-jb-minimum-total-supply-input" min="1">
              </div>
            </div>
          </div>
          <div class="form-section" style="display: none;">
            <div class="form-item form-item-large">
              <div class="form-label">Addresses allowed to buy (one per line)</div>
              <div class="form-value">
                <textarea rows="4" id="fork-form-new-jb-addresses-input" placeholder="leave empty for no restrictions"></textarea>
              </div>
            </div>
          </div>
          <div id="fork-form-new-jb-chain" class="form-section">
            <div class="form-section-description">Choose where you want your collection. Each will ask for a signature.</div>
            <div class="form-item">
              <div class="form-value form-select-value">
                <select id="fork-form-new-jb-state-chain-env" name="chain-env">
                  <option value="production">Production</option>
                  <option value="testnet">Testnet</option>
                </select>
              </div>
              <div class="form-value form-chain-checkbox-value">
                <div id="fork-form-new-jb-chain-production-options" class="form-chain-options">
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-ethereum-mainnet" name="chain" value="ethereum mainnet">
                    <label for="fork-form-new-jb-ethereum-mainnet">Ethereum</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-optimism-mainnet" name="chain" value="optimism mainnet">
                    <label for="fork-form-new-jb-optimism-mainnet">Optimism</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-arbitrum-mainnet" name="chain" value="arbitrum mainnet">
                    <label for="fork-form-new-jb-arbitrum-mainnet">Arbitrum</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-base-mainnet" name="chain" value="base mainnet">
                    <label for="fork-form-new-jb-base-mainnet">Base</label>
                  </div>
                </div>
                <div id="fork-form-new-jb-chain-testnet-options" class="form-chain-options" style="display: none;">
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-ethereum-sepolia" name="chain" value="ethereum sepolia">
                    <label for="fork-form-new-jb-ethereum-sepolia">Ethereum Sepolia</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-optimism-sepolia" name="chain" value="optimism sepolia">
                    <label for="fork-form-new-jb-optimism-sepolia">Optimism Sepolia</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-arbitrum-sepolia" name="chain" value="arbitrum sepolia">
                    <label for="fork-form-new-jb-arbitrum-sepolia">Arbitrum Sepolia</label>
                  </div>
                  <div class="form-checkbox-option">
                    <input type="checkbox" id="fork-form-new-jb-base-sepolia" name="chain" value="base sepolia">
                    <label for="fork-form-new-jb-base-sepolia">Base Sepolia</label>
                  </div>
                </div>
              </div>
            </div>
          </div>           
          <div id="fork-form-new-jb-relayr-quote-section" style="display: none;" class="form-section">
            <div id="fork-form-new-jb-relayr-quote-details" class="form-quote-details"></div>
            <div id="fork-form-new-jb-relayr-payment-options" class="form-payment-options">
              <!-- Payment options will be dynamically inserted here -->
            </div>
            <div id="fork-form-new-jb-relayr-deploy-status" style="display: none;" class="form-deploy-status"></div>
          </div>
          <div id="fork-form-new-jb-error-message" class="form-error-message mobile-padding"></div>
          <button id="fork-form-new-jb-submit-button" class="form-button"><span id="fork-form-new-jb-submit-button-text" class="form-button-text">deploy collection</span><span id="fork-form-new-jb-button-loading-animation" class="loading-animation button-loading-animation"></span></button> 
          <div id="fork-form-new-jb-success-message" class="form-success-message mobile-padding"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
  
    let relayrQuote = null;
    let selectedPaymentChainId = null;
    let relayrPolling = false;
    let relayrTxHashes = {};

    const decorateNewJbForm = () => {
      const forkFormChainInput = document.getElementById("fork-form-state-chain-input");
      const forkFormNewJbCollectionNameInput = document.getElementById("fork-form-new-jb-collection-name-input");
      const forkFormNewJbCollectionTickerInput = document.getElementById("fork-form-new-jb-collection-symbol-input");
      const forkFormNewJbProjectOwnerInput = document.getElementById("fork-form-new-jb-project-owner-input");
      const forkFormNewJbMinimumPriceInput = document.getElementById("fork-form-new-jb-minimum-price-input");
      const forkFormNewJbMinimumTotalSupplyInput = document.getElementById("fork-form-new-jb-minimum-total-supply-input");
      const forkFormNewJbAddressesInput = document.getElementById("fork-form-new-jb-addresses-input");
      const forkFormNewJbErrorMessage = document.getElementById("fork-form-new-jb-error-message");
      const forkFormNewJbSuccessMessage = document.getElementById("fork-form-new-jb-success-message");
      const forkFormNewJbSubmitButton = document.getElementById("fork-form-new-jb-submit-button");
      const forkFormNewJbChainEnvSelect = document.getElementById('fork-form-new-jb-state-chain-env');
      const forkFormNewJbChainProductionOptions = document.getElementById('fork-form-new-jb-chain-production-options');
      const forkFormNewJbChainTestnetOptions = document.getElementById('fork-form-new-jb-chain-testnet-options');
  
      // Disable the button.
      forkFormNewJbSubmitButton.disabled = true;
  
      // Set values in the form if the fields are not yet set.
      if (!forkFormNewJbProjectOwnerInput.value && signer) forkFormNewJbProjectOwnerInput.value = signer;
  
      // Allow connecting wallet to prefill beneficiary input field.
      const loadAddressButton = document.getElementById("fork-form-new-jb-load-address-button");
      loadAddressButton.onclick = async () => {
        signer = (await getSigner()).address;
        forkFormNewJbProjectOwnerInput.value = signer;
      };
  
      forkFormNewJbChainEnvSelect.addEventListener('change', function() {
        if (this.value === 'production') {
          forkFormNewJbChainProductionOptions.style.display = 'block';
          forkFormNewJbChainTestnetOptions.style.display = 'none';
        } else {
          forkFormNewJbChainProductionOptions.style.display = 'none';
          forkFormNewJbChainTestnetOptions.style.display = 'block';
        }
      });
  
  
  
      const checkState = async () => {
        // Hide the error message.
        forkFormNewJbErrorMessage.style.display = "none";
        forkFormNewJbSubmitButton.disabled = false;
      }
  
      // Prevent excessive calls.
      let checkStateTimer;
      const queueCheckState = async () => {
        clearTimeout(checkStateTimer);
        checkStateTimer = setTimeout(checkState, formInputReactionTimeDelay);
      }
  
      // Update the form's state each time the values change.
      forkFormNewJbCollectionNameInput.addEventListener("input", queueCheckState);
      forkFormNewJbCollectionTickerInput.addEventListener("input", queueCheckState);
      forkFormNewJbMinimumPriceInput.addEventListener("input", queueCheckState);
      forkFormNewJbMinimumTotalSupplyInput.addEventListener("input", queueCheckState);
  
      // Set values in the form if the fields are not yet set.
      // Default to 1
      if (!forkFormNewJbMinimumTotalSupplyInput.value) forkFormNewJbMinimumTotalSupplyInput.value = 1;
      // Default to free
      if (!forkFormNewJbMinimumPriceInput.value) forkFormNewJbMinimumPriceInput.value = 0;
  
      // Get selected chain IDs
      const getSelectedChainIds = () => {
        const env = document.getElementById('fork-form-new-jb-state-chain-env').value;
        const optionsId = env === 'production' 
          ? 'fork-form-new-jb-chain-production-options'
          : 'fork-form-new-jb-chain-testnet-options';
        const checkboxes = document.querySelectorAll(`#${optionsId} input[type="checkbox"]:checked`);
        return Array.from(checkboxes).map(cb => resolveChainId(cb.value));
      };

      // Update button text based on selected chains
      const updateDeployButtonText = () => {
        const selectedChains = getSelectedChainIds();
        const buttonText = selectedChains.length > 1 ? "get deploy quote" : "deploy collection";
        document.getElementById('fork-form-new-jb-submit-button-text').textContent = buttonText;
      };

      // Add chain selection change listeners
      const chainCheckboxes = document.querySelectorAll('input[name="chain"]');
      chainCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateDeployButtonText);
      });

      // Set loading state
      const setLoadingState = (state) => {
        const submitButton = document.getElementById('fork-form-new-jb-submit-button');
        const loadingAnimation = document.getElementById('fork-form-new-jb-button-loading-animation');
        if (state) {
          submitButton.disabled = true;
          loadingAnimation.style.display = 'inline-block';
          // Show extra text only for get deploy quote
          const btnText = document.getElementById('fork-form-new-jb-submit-button-text').textContent;
        } else {
          submitButton.disabled = false;
          loadingAnimation.style.display = 'none';
        }
      };

      // Show error
      const showError = (message) => {
        const errorMessage = document.getElementById('fork-form-new-jb-error-message');
        errorMessage.innerHTML = message;
        errorMessage.style.display = "block";
      };

      // Show success
      const showSuccess = (message) => {
        const successMessage = document.getElementById('fork-form-new-jb-success-message');
        successMessage.innerHTML = message;
        successMessage.style.display = "block";
      };

      // Reset form and UI
      const resetFormAndUI = () => {
        const successMessage = document.getElementById('fork-form-new-jb-success-message');
        const errorMessage = document.getElementById('fork-form-new-jb-error-message');
        const relayrSection = document.getElementById('fork-form-new-jb-relayr-quote-section');
        
        successMessage.style.display = "none";
        errorMessage.style.display = "none";
        relayrSection.style.display = 'none';
        
        // Restore original button text
        updateDeployButtonText();
        
        selectedPaymentChainId = null;
        relayrQuote = null;
        relayrPolling = false;
      };

      const showRelayrQuoteUI = (quote) => {
        const relayrSection = document.getElementById('fork-form-new-jb-relayr-quote-section');
        const paymentOptionsDiv = document.getElementById('fork-form-new-jb-relayr-payment-options');
        const submitButton = document.getElementById('fork-form-new-jb-submit-button');
        
        relayrSection.style.display = 'block';
        // Don't hide the submit button - we're reusing it
        paymentOptionsDiv.innerHTML = '';

        // Quote status
        const statusBox = document.createElement('div');
        statusBox.className = 'form-quote-status-box';
        statusBox.innerHTML = `Quote complete <span style="color: #3bb273; font-size: 1.3em; margin-left: 8px;">&#10003;</span>`;
        paymentOptionsDiv.appendChild(statusBox);

        // Expiry (5 min default)
        const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // or use quote.expiry if available
        const expiresText = document.createElement('div');
        expiresText.className = 'form-quote-expiry';
        expiresText.innerHTML = `Quote valid until <b>${expiresAt.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'})}</b>. <a href="#" id="clear-quote-link" class="form-clear-quote-link">clear quote</a>`;
        paymentOptionsDiv.appendChild(expiresText);

        // Payment dropdown label
        const label = document.createElement('div');
        label.innerText = 'How would you like to pay?';
        label.className = 'form-label';
        paymentOptionsDiv.appendChild(label);

        // Payment dropdown (styled like the rest of the site)
        const formItem = document.createElement('div');
        formItem.className = 'form-item';

        const selectWrapper = document.createElement('div');
        selectWrapper.className = 'form-value form-select-value';

        const select = document.createElement('select');
        select.id = 'relayr-payment-chain-dropdown';

        quote.payment_info.forEach((info, idx) => {
          const opt = document.createElement('option');
          opt.value = idx;
          const eth = formatEth(info.amount);
          const chain = resolveChainLabel(info.chain) || info.chain;
          opt.innerText = `${eth} ETH on ${chain}`;
          select.appendChild(opt);
        });
        selectWrapper.appendChild(select);
        formItem.appendChild(selectWrapper);
        paymentOptionsDiv.appendChild(formItem);

        // Reuse the existing submit button for deployment
        const existingSubmitButton = document.getElementById('fork-form-new-jb-submit-button');
        const existingButtonText = document.getElementById('fork-form-new-jb-submit-button-text');
        const existingSpinner = document.getElementById('fork-form-new-jb-button-loading-animation');
        
        // Update button text to "deploy collection"
        existingButtonText.textContent = 'deploy collection';
        existingSubmitButton.disabled = false;
        
        // Store the original onclick handler
        const originalOnclick = existingSubmitButton.onclick;
        
        // Replace the onclick handler for quote deployment
        existingSubmitButton.onclick = async () => {
          const idx = select.value;
          const paymentInfo = quote.payment_info[idx];
          existingSubmitButton.disabled = true;
          startLoadingAnimation('fork-form-new-jb-button-loading-animation');
          try {
            const sendTx = sendRelayrTx(paymentInfo);
            // Robust logging and error handling for status table
            try {
              const statusDiv = document.getElementById('fork-form-new-jb-relayr-deploy-status');
              statusDiv.style.display = 'block';
              renderRelayrStatusTable({transactions: quote.payment_info.map((info) => ({
                request: {chain: info.chain},
                status: {state: 'Pending'}
              }))});
              pollRelayrBundleStatus(quote.bundle_uuid, renderRelayrStatusTable);
              await sendTx;
            } catch (tableErr) {
              showError('Error showing deployment status. Please try again or contact support.');
            }
          } catch (e) {
            let msg = e && e.message ? e.message : String(e);
            if (msg.includes('insufficient funds')) {
              msg = 'Insufficient funds for gas and payment.';
            }
            showError(msg);
          } finally {
            existingSubmitButton.disabled = false;
            stopLoadingAnimation('fork-form-new-jb-button-loading-animation');
          }
        };

        // Clear quote handler
        setTimeout(() => {
          const clearLink = document.getElementById('clear-quote-link');
          if (clearLink) {
            clearLink.onclick = (e) => {
              e.preventDefault();
              relayrSection.style.display = 'none';
              
              // Restore original button functionality
              existingSubmitButton.onclick = originalOnclick;
              updateDeployButtonText(); // Restore original button text
              
              // Optionally reset state/quote here
            };
          }
        }, 0);
      };

      // Submit the form.
      forkFormNewJbSubmitButton.onclick = async () => {
        // Check for empty values.
        if (!forkFormNewJbCollectionNameInput.value || !forkFormNewJbCollectionTickerInput.value || forkFormNewJbMinimumPriceInput.value == "" || !forkFormNewJbMinimumTotalSupplyInput.value) {
          forkFormNewJbErrorMessage.innerHTML = "Fill out the form.";
          forkFormNewJbErrorMessage.style.display = "block";
          return;
        } 
  
        // Default to the signer.
        signer = (await getSigner()).address;
        if (!forkFormNewJbProjectOwnerInput.value) forkFormNewJbProjectOwnerInput.value = signer;
  
        // Show the loading animation.
        startLoadingAnimation('fork-form-new-jb-button-loading-animation');
  
        // Get selected chain IDs
        const selectedChainIds = getSelectedChainIds();
        if (selectedChainIds.length === 0) {
          showError("Please select at least one chain");
          return;
        }
  
        // Normalize values from the form.
        const name = forkFormNewJbCollectionNameInput.value;
        const symbol = forkFormNewJbCollectionTickerInput.value;
        const owner = forkFormNewJbProjectOwnerInput.value;
        const minimumPrice = fixedPointNumber(forkFormNewJbMinimumPriceInput.value, 18);
        const supply = forkFormNewJbMinimumTotalSupplyInput.value;
        const minimumTotalSupply = BigInt(supply);
        const maximumTotalSupply = BigInt(supply);
        const allowedAddresses = !forkFormNewJbAddressesInput.value ? [] : forkFormNewJbAddressesInput.value.split('\n');
        const stage1AutomintTokenAmount = 0; // Default to 0 automints
        const stage2AutomintTokenAmount = 0; // No stage 2
        const stage3AutomintTokenAmount = 0; // No stage 3
        const stage1InitialIssuanceAmount = fixedPointNumber("10000", 18); // Default to 10000 issuance with 18 decimals
        const stage2InitialIssuanceAmount = 0; // No stage 2
        const stage3InitialIssuanceAmount = 0; // No stage 3
        const stage1SplitPercent = 10000 - Math.round(62 * 100); // 62% reward
        const stage2SplitPercent = 0; // No stage 2
        const stage3SplitPercent = 0; // No stage 3
        const stage1PriceIncreasePercent = 10_000_000; // 1% bonus
        const stage2PriceIncreasePercent = 0; // No stage 2
        const stage3PriceIncreasePercent = 0; // No stage 3
        const stage1PriceIncreaseFrequency = 7 * 86400; // Every 7 days
        const stage2PriceIncreaseFrequency = 0; // No stage 2
        const stage3PriceIncreaseFrequency = 0; // No stage 3
        const stage1CashOutTaxRate = 1000; // Default to 0.1 (10%)
        const stage2CashOutTaxRate = 0; // No stage 2
        const stage3CashOutTaxRate = 0; // No stage 3
        const stage2StartsAtOrAfter = 0; // No stage 2
        const stage3StartsAtOrAfter = 0; // No stage 3
        
        try {
          // Generate a salt for this deploy
          const salt = generateSalt();

          // Always create a revnet (no dropdown anymore)
          const isRevnet = true;

          // If multiple chains are selected, use Relayr
          if (selectedChainIds.length > 1) {
            let quote;
            if (isRevnet) {
              quote = await tx_deploy_revnet(
                name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply,
                allowedAddresses, stage1AutomintTokenAmount, stage2AutomintTokenAmount, stage3AutomintTokenAmount,
                stage1InitialIssuanceAmount, stage2InitialIssuanceAmount, stage3InitialIssuanceAmount,
                stage1SplitPercent, stage2SplitPercent, stage3SplitPercent,
                stage1PriceIncreasePercent, stage2PriceIncreasePercent, stage3PriceIncreasePercent,
                stage1PriceIncreaseFrequency, stage2PriceIncreaseFrequency, stage3PriceIncreaseFrequency,
                stage1CashOutTaxRate, stage2CashOutTaxRate, stage3CashOutTaxRate,
                stage2StartsAtOrAfter, stage3StartsAtOrAfter, selectedChainIds, salt
              );
            } else {
              quote = await tx_deploy_project(
                name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply, 
                allowedAddresses, selectedChainIds, salt
              );
            }
            
            if (!quote || !quote.payment_info) {
              throw new Error('Failed to get valid Relayr quote');
            }

            relayrQuote = quote;
            showRelayrQuoteUI(quote);
            return;
          }

          // Single chain deployment
          let collectionAddress;
          if (isRevnet) {
            collectionAddress = await tx_deploy_revnet(
              name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply,
              allowedAddresses, stage1AutomintTokenAmount, stage2AutomintTokenAmount, stage3AutomintTokenAmount,
              stage1InitialIssuanceAmount, stage2InitialIssuanceAmount, stage3InitialIssuanceAmount,
              stage1SplitPercent, stage2SplitPercent, stage3SplitPercent,
              stage1PriceIncreasePercent, stage2PriceIncreasePercent, stage3PriceIncreasePercent,
              stage1PriceIncreaseFrequency, stage2PriceIncreaseFrequency, stage3PriceIncreaseFrequency,
              stage1CashOutTaxRate, stage2CashOutTaxRate, stage3CashOutTaxRate,
              stage2StartsAtOrAfter, stage3StartsAtOrAfter, selectedChainIds, salt
            );
          } else {
            collectionAddress = await tx_deploy_project(
              name, symbol, owner, minimumPrice, minimumTotalSupply, maximumTotalSupply,
              allowedAddresses, selectedChainIds, salt
            );
          }

          if (!collectionAddress) {
            showError("The connected network isn't supported.");
          } else {
            showSuccess(`Success! ${collectionAddress} is your collection's address on chain ID ${selectedChainIds[0]}.`);
          }

        } catch (e) {
          console.log({ e });
          showError(e.message || e);
        } finally {
          setLoadingState(false);
        }
      };

      // Initial button text update
      updateDeployButtonText();
    }
  
  

    function renderRelayrStatusTable(bundleStatus) {
      const statusDiv = document.getElementById('fork-form-new-jb-relayr-deploy-status');
      statusDiv.style.display = 'block';

      if (!bundleStatus || !Array.isArray(bundleStatus.transactions)) {
        statusDiv.innerHTML = '<div class="relayr-status-table-failed">Error: Could not load deployment status. Please try again or contact support.</div>';
        return;
      }

      // Table container styling
      let html = `<div class="relayr-status-table-desc">
        Your project is made up of components deployed on each blockchain where it'll accept funds and issue tokens from. These transactions take 1-2 minutes to settle.
      </div>`;

      html += `<div class="relayr-status-table-container">
        <table class="relayr-status-table">
          <tr>
            <th>Network</th>
            <th>Status</th>
            <th>Tx</th>
          </tr>`;

      let collectionAddress = null;
      for (const tx of bundleStatus.transactions) {
        const chain = resolveChainLabel(tx.request.chain) || tx.request.chain;
        const state = tx.status && tx.status.state;
        let statusIcon = '';
        let statusText = '';
        // Persist and use tx hash
        let txHash = tx.status && (tx.status.tx_hash || (tx.status.data && tx.status.data.transaction && tx.status.data.transaction.hash));
        if (txHash) {
          relayrTxHashes[tx.request.chain] = txHash;
        } else if (relayrTxHashes[tx.request.chain]) {
          txHash = relayrTxHashes[tx.request.chain];
        }
        let txLink = '<span class="relayr-status-table-txlink">generating...</span>';

        if (state === 'Pending' || state === 'Mempool') {
          statusIcon = `<span class="relayr-status-table-pending" style="font-size:1.2em; vertical-align:middle;">&#9711;</span>`;
          statusText = 'Pending';
        } else if (state === 'Success' || state === 'Included') {
          statusIcon = `<span class="relayr-status-table-success" style="font-size:1.2em; vertical-align:middle;">&#10003;</span>`;
          statusText = state;
          if (txHash) {
            const explorer = chainExplorerUrls(tx.request.chain);
            txLink = `<a href="${explorer}${txHash}" target="_blank" class="relayr-status-table-success">View</a>`;
          }

          // Extract collection address from calldata if available
          if (tx.receipt && !collectionAddress) {
            const interface = new ethers.Interface(croptopDeployerContractABI);
            const decodedLog = interface.parseLog(tx.receipt.logs[0]);
            collectionAddress = decodedLog.args[1]; 
          }
        } else if (state === 'Failed') {
          statusIcon = `<span class="relayr-status-table-failed" style="font-size:1.2em; vertical-align:middle;">&#10007;</span>`;
          statusText = 'Failed';
          txLink = '-';
        } else {
          statusIcon = '';
          statusText = 'Unknown';
          txLink = '-';
        }

        html += `<tr>
          <td>${chain}</td>
          <td>${statusIcon} ${statusText}</td>
          <td>${txLink}</td>
        </tr>`;
      }
      html += '</table></div>';

      // Show collection address if available
      if (collectionAddress) {
        html += `<div class="relayr-status-table-address">Collection address: ${collectionAddress}</div>`;
      }

      // Show help message if at least one tx has been successful or has a View link
      const hasSuccessfulTx = bundleStatus.transactions.some(tx => {
        const state = tx.status && tx.status.state;
        return (state === 'Success' || state === 'Included');
      });
      const hasViewLink = bundleStatus.transactions.some(tx => {
        const state = tx.status && tx.status.state;
        return (state === 'Success' || state === 'Included') && (tx.status && (tx.status.tx_hash || (tx.status.data && tx.status.data.transaction && tx.status.data.transaction.hash)));
      });
      
      // Show help message if there are successful transactions (even if View links aren't available yet)
      if (hasSuccessfulTx || hasViewLink) {
        html += `<div class="relayr-status-table-help">
          <b>How to find your collection (hook) address:</b><br>
          Click a <span class='relayr-status-table-success'>View</span> button, go to the <b>Logs</b> tab, and read the first event.
        </div>`;
      }

      statusDiv.innerHTML = html;
    }
  </script>
