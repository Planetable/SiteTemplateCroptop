{% extends 'base.html' %}

{% block head %}
{% include 'modules/deps.html' %}
{% include 'modules/ethers.html' %}
{% include 'modules/utils.html' %}
{% include 'modules/tx.html' %}
{% include 'modules/record_and_collect.html' %}
{% include 'modules/planet_seo.html' %}

{% block dom_ready %}
{% endblock %}

{% block main %}
<div class="top">
  {% if has_avatar == true %}
  <img src="{{ assets_prefix }}avatar.png" width="72" height="72" class="avatar">
  {% endif %}
  <div class="site-info">
    <div class="site-title">{{ page_title|escape }}</div>
    {% if page_description_html.count > 0 %}<div class="site-about">{{ page_description_html }}</div>{% endif %}
  </div>
  <div class="site-detail">
    <span>source</span>
  </div>
  {% include 'modules/social_icons.html' %}
</div>
{% include 'modules/nav.html' %}
<div id="loading-animation"></div>
<div id="frames"></div>
<div id="modal" class="modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modal-image">
  <video class="modal-content" id="modal-video"></video>
  <div id="modal-caption"></div>
</div>
<script>
  const frames = document.getElementById("frames");
  const horizontalMargin = 24;
  const verticalMargin = 10;
  const transitionDuration = 300;
  const widthClasses = ["w1", "w2", "w3"];
  const loadingAnimationPace = 100;
  let loadingAnimationInterval;
  let currentRow = 1;
  let greatestRightInRow = 0;
  let rows = [];

  const getRandomWidthClass = () =>
    widthClasses[Math.floor(Math.random() * widthClasses.length)];

  const startLoadingAnimation = () => {
    const loadingAnimation = document.getElementById('loading-animation');
    const loadingAnimationFrames = ['-', '\\', '|', '/'];
    let currentFrame = 0;

    const animate = () => {
      loadingAnimation.textContent = loadingAnimationFrames[currentFrame];
      currentFrame = (currentFrame + 1) % loadingAnimationFrames.length;
      loadingAnimationInterval = setTimeout(animate, loadingAnimationPace);
    }

    animate();
  }

  const stopLoadingAnimation = () => {
    const loadingAnimation = document.getElementById('loading-animation');
    loadingAnimationInterval = clearTimeout(loadingAnimationInterval);
    loadingAnimation.style.display = "none";
  }

  const getTopTarget = (frame, row) => {
    if (row == 1) return frames.offsetTop;

    let previousRow = rows[row - 2];
    let candidateFrame;

    for (let j = 0; j < previousRow.frames.length; j++) {
      let frameToCheck = previousRow.frames[j];

      if (
        frame.left < frameToCheck.right + horizontalMargin &&
        frame.right + horizontalMargin > frameToCheck.left &&
        (candidateFrame == null || frameToCheck.bottom > candidateFrame.bottom)
      ) candidateFrame = frameToCheck;
      else if (frame.right <= frameToCheck.left) {
        return candidateFrame ? candidateFrame.bottom : getTopTarget(frame, row - 1);
      }
    }

    return candidateFrame.bottom;
  };

  const loadFrame = async (frame) => {
    const img = frame.querySelector('img:first-of-type');
    return new Promise((resolve) => {
      // Resolve if the image if done.
      if (img.complete) return resolve();

      const checkForDimensions = () => {
        // Resolve if the img has dimensions. Small delay to let more of the img load for a smoother slide in.
        if (img.width > 0 && img.height > 0) return setTimeout(resolve, 1000);
        // Otherwise wait until the image has dimensions.
        else
          return requestAnimationFrame(checkForDimensions);
      }

      checkForDimensions();
    });
  };

  const frameImage = (itemID, src, desc, title, link, video) => {
    const imageFrame = document.createElement("div");
    imageFrame.classList.add("frame");
    imageFrame.style.transitionProperty = "opacity, margin-top";
    imageFrame.style.transitionDuration = `${transitionDuration / 1000}s, ${transitionDuration / 1000}s`;
    imageFrame.style.transitionTimingFunction = "ease, ease";

    const widthClass = getRandomWidthClass();

    const imgHeader = document.createElement("div");
    imgHeader.classList.add("image-header");
    imgHeader.classList.add(widthClass);

    const imgDescription = document.createElement("div");
    imgDescription.innerHTML = desc;
    imgDescription.classList.add("image-detail");

    const img = document.createElement("img");
    img.classList.add(widthClass);
    img.loading = "lazy";
    img.src = src;
    img.style.cursor = "pointer";

    const imgCta = document.createElement("div");
    const anchor = document.createElement('a');
    anchor.textContent = '[record]';
    anchor.style.textDecoration = "line-through";
    imgCta.appendChild(anchor);
    imgCta.classList.add("image-cta");

    const projectId = 654;
    const category = 2;
    const quantity = 3;
    const price = 100000000000000000;
    const cidUrl = `{{ assets_prefix }}${itemID}/nft.json.cid.txt`;
    fetch(cidUrl)
      .then(response => response.text())
      .then(data => {
        const encodedIPFSUri = encodeIPFSUri(data);
        anchor.href = `javascript:recordAndCollect(${projectId}, ${category}, ${quantity}, "${price}", "${encodedIPFSUri}");`;
      }
    );

    if (link) {
      img.addEventListener("click", () => window.open(link, "_blank"));
    } else {
      img.addEventListener("click", () => {
        const modal = document.getElementById("modal");
        modal.style.display = "block";
        modal.addEventListener("click", () => {
          if (video) {
            modalVideo.pause();
          }
          modal.style.display = "none";
        });
        const modalImage = document.getElementById("modal-image");
        const modalVideo = document.getElementById("modal-video");

        if (video) {
          modalImage.style.display = "none"
          modalVideo.style.display = "block"
          modalVideo.autoplay = true;
          modalVideo.loop = true;
          modalVideo.muted = true;
          modalVideo.controls = true;
          modalImage.src = "";
          modalVideo.src = video;

          modalVideo.addEventListener('click', (event) => {
            event.stopPropagation();
          });
        } else {
          modalImage.style.display = "block"
          modalVideo.style.display = "none"

          modalVideo.src = "";
          modalImage.src = src;

          modalImage.addEventListener('click', (event) => {
            event.stopPropagation();
          });

          // try fetch NFT metadata and console.log it
          const metadataUrl = `{{ assets_prefix }}${itemID}/nft.json`;
          fetch(metadataUrl)
            .then(response => response.json())
            .then(data => {
              console.log(data);
            });
          // try fetch nft.json.cid.txt and console.log it
          const cidUrl = `{{ assets_prefix }}${itemID}/nft.json.cid.txt`;
          fetch(cidUrl)
            .then(response => response.text())
            .then(data => {
              console.log(data);
            });
        }
        const modalCaption = document.getElementById("modal-caption");
        modalCaption.innerHTML = desc;
        const span = document.getElementsByClassName("close")[0];
        span.onclick = function () {
          if (video) {
            modalVideo.pause();
          }
          modal.style.display = "none";
        }
      });
    }

    imgHeader.appendChild(imgCta);
    imgHeader.appendChild(imgDescription);
    imageFrame.appendChild(imgHeader);
    imageFrame.appendChild(img);
    frames.appendChild(imageFrame);

    return imageFrame;
  };

  const positionAndShowFrame = async (imageFrame) => {
    await loadFrame(imageFrame);

    if (loadingAnimationInterval) stopLoadingAnimation();

    const rect = imageFrame.getBoundingClientRect();
    if (rect.left < greatestRightInRow) currentRow++;
    greatestRightInRow = rect.right;

    const heightDiff = rect.top - getTopTarget(rect, currentRow);
      let newFrame = { left: rect.left, right: rect.right, bottom: rect.bottom - heightDiff + verticalMargin };

    if (currentRow > rows.length) rows.push({ frames: [newFrame] });
    else rows[rows.length - 1].frames.push(newFrame);

    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const marginTop = heightDiff + scrollTop - verticalMargin;
    imageFrame.classList.add("frame-fade-in");

    return new Promise((resolve) => {
      if (marginTop) {
        const handleEvent = (event) => {
          if (event.propertyName === "margin-top") {
            imageFrame.removeEventListener("transitionend", handleEvent);
            resolve();
          }
        };
        imageFrame.addEventListener("transitionend", handleEvent);
        imageFrame.style.marginTop = -marginTop + "px";
      } else setTimeout(resolve, transitionDuration);
    });
  }

  const loadImageFrames = async () => {
    const response = await fetch(
      `{{ assets_prefix }}planet.json`
    );
    const data = await response.json();
    const frames = data['articles']
      // Only if attachments have file extensions like ".jpg" ".png" ".gif"
      .filter(item => item.hasVideo === true || item.attachments.some(attachment => attachment.match(/\.(jpg|png|gif)$/i)))
      .map((item) => {
        // if item.hasVideo, use _videoThumbnail.png
        // else use a random attachment
        const imageName = item.hasVideo ? '_videoThumbnail.png' : item.attachments[Math.floor(Math.random() * item.attachments.length)];
        const videoName = item.hasVideo ? './' + item.id + '/' + item.videoFilename : null;
        return frameImage(item.id, './' + item.id + '/' + imageName, formatTimestamp(item.created), item.title, item.externalLink, videoName);
      }
    );
    for (const frame of frames) 
      await positionAndShowFrame(frame);
  };

  loadImageFrames();
  startLoadingAnimation();
</script>
{% endblock %}
